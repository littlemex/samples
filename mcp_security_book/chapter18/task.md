# MCP Serverセキュリティ対策の実装設計

## 概要

本タスクでは、MCP Serverのセキュリティに関する問題点と対策を実装します。具体的には、MCP Serverのツール説明が実行時に変更される脆弱性を示し、それを検知・防止する仕組みを構築します。

## 実装要件

1. **MCP Serverのツール説明変更機能の実装**
   - add.tsのツール説明をサーバー稼働中に変更できるAPIエンドポイントを追加
   - 別のメッセージに切り替える機能（悪意のあるメッセージにしてしまうと実際の攻撃に使われてしまう可能性がある）
   - 変更があった場合に通知する機能（listChangedの要件に準拠）

2. **MCP Server利用者側の対応**
   - MCP Serverから返却されるツール情報とバージョンの取得
   - 取得した情報のハッシュ化
   - ハッシュ値をローカルのJSONファイルに保存
   - データ形式: "サーバパス(localhost:13000)-MCP Serverバージョン-ツール名"をキーとして、サーバーパス、バージョン、ツール名、ハッシュ値をバリューとして保持

3. **ツール定義変更検知スクリプトの作成（Python）**
   - 保存されたハッシュ値と現在のツール定義のハッシュ値を比較
   - 変更があった場合に警告を表示

4. **MCP Serverの_metaフィールドを利用したハッシュ値提供機能**
   - ツール定義のハッシュ値を_metaフィールドに含める
   - クライアント側でこの値を参照できるようにする

## 技術的アプローチ

### 1. MCP Serverのツール説明変更機能

```typescript
// 実装方針
// 1. 複数のツール説明を用意（通常版と変更版）
// 2. 現在のツール説明状態を管理する変数を追加
// 3. ツール説明を切り替えるAPIエンドポイント（/change-description）を追加
// 4. getServer関数を修正して、現在の状態に応じたツール説明を返すように変更
// 5. 変更通知機能の実装（コンソールログまたはイベント発火）
```

### 2. MCP Server利用者側の対応

```typescript
// 実装方針
// 1. MCP Serverからツール情報を取得する関数を実装
// 2. 取得した情報をハッシュ化する関数を実装（crypto.createHash使用）
// 3. ハッシュ値をJSONファイルに保存する関数を実装
// 4. 初回接続時にハッシュ値を保存し、以降の接続時に比較する仕組みを実装
```

### 3. ツール定義変更検知スクリプト（Python）

```python
# 実装方針
# 1. JSONファイルからハッシュ値を読み込む
# 2. MCP Serverに接続してツール定義を取得
# 3. 取得したツール定義からハッシュ値を計算
# 4. 保存されたハッシュ値と比較
# 5. 変更があれば警告を表示
```

### 4. _metaフィールドを利用したハッシュ値提供

```typescript
// 実装方針
// 1. McpServer初期化時に_metaフィールドを設定
// 2. ツール定義のハッシュ値を計算し、_metaフィールドに追加
// 3. クライアント側でこの値を取得して検証できるようにする
```

## 実装ステップ

1. まず、add.tsを修正して、ツール説明を変更するAPIエンドポイントを追加します。
2. 次に、MCP Server利用者側の対応として、ハッシュ値を保存・検証するクライアントスクリプトを作成します。
3. Pythonでツール定義変更検知スクリプトを実装します。
4. 最後に、_metaフィールドを利用したハッシュ値提供機能を実装します。

## 検証方法

1. MCP Serverを起動し、初期状態のツール説明を確認
2. クライアントスクリプトを実行して初期ハッシュ値を保存
3. APIエンドポイントを呼び出してツール説明を変更
4. 変更検知スクリプトを実行して警告が表示されることを確認
5. _metaフィールドからハッシュ値が取得できることを確認

## セキュリティ上の考慮事項

- ハッシュアルゴリズムはSHA-256を使用
- ツール定義変更は重大なセキュリティリスクとして扱い、検知した場合は即座に警告
- 実運用環境では、ハッシュ値の検証を自動化し、定期的に実行することを推奨
