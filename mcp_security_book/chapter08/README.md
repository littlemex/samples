# Chapter 08

Docker `--init` フラグ実験

このディレクトリには、Docker の `--init` フラグの効果を実証するための実験スクリプトが含まれています。この実験では、以下の2つの重要な問題を実際に確認できます：

1. シグナル処理の問題（PID 1 プロセスの特殊な扱い）
2. ゾンビプロセスの処理問題

## ファイル構成

- `Dockerfile`: 実験用のコンテナイメージを定義
- `zombie_maker.sh`: ゾンビプロセスを意図的に作成するスクリプト
- `signal_handler.sh`: シグナル処理の違いを確認するスクリプト
- `run_experiment.sh`: 実験を自動的に実行するスクリプト

## 実験の実行方法

```bash
chmod +x run_experiment.sh
./run_experiment.sh
```

実験は2段階で実行されます：

1. `--init` なしのコンテナ実行
   - コンテナ内で定期的にサブプロセスが生成されます
   - プロセスの状態が継続的に表示されます
   - ログを確認後、Ctrl+C で次のステップに進みます
   - コンテナの停止に約10秒かかることを確認できます

2. `--init` ありのコンテナ実行
   - 同様にサブプロセスが生成されます
   - Tini による適切なプロセス管理を確認できます
   - ログを確認後、Ctrl+C で次のステップに進みます
   - コンテナがすぐに停止することを確認できます

## 実験で確認できること

### 1. シグナル処理の違い

- `--init` なしの場合：
  - PID 1 として実行されるプロセスがシグナルを無視
  - `docker stop` コマンドが SIGTERM を送信しても反応なし
  - 10秒のタイムアウト後に SIGKILL で強制終了

- `--init` ありの場合：
  - Tini が PID 1 として実行され、シグナルを適切に処理
  - `docker stop` コマンドの SIGTERM に即座に反応
  - グレースフルシャットダウンが可能

### 2. ゾンビプロセスの処理

- `--init` なしの場合：
  - 終了したサブプロセスがゾンビプロセス（`<defunct>`）として残留
  - `ps` コマンドでゾンビプロセスが確認可能

- `--init` ありの場合：
  - Tini がサブプロセスの終了を適切に処理
  - ゾンビプロセスが発生しない

## 実験結果の解釈

1. `docker stop` コマンドの実行時間を比較：
   - `--init` なし：約10秒（タイムアウトまで待機）
   - `--init` あり：ほぼ即座に終了

2. `ps axf` の出力を比較：
   - `--init` なし：`<defunct>` プロセスの存在を確認
   - `--init` あり：すべてのプロセスが正常

この実験により、`--init` フラグがコンテナのプロセス管理において重要な役割を果たすことが実証されます。
