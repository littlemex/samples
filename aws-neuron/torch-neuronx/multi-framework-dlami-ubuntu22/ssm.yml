Description: SSM Document for code-server instance

Parameters:
  CodeServerUser:
    Type: String
    Description: UserName for code-server
  HomeFolder:
    Type: String
    Description: Folder to open in code-server
  DevServerBasePath:
    Type: String
    Description: Base path for the application to be added to Nginx sites-available list
  DevServerPort:
    Type: Number
    Description: Port for the DevServer
  RepoUrl:
    Description: Remote repo URL to clone. To not clone a remote repo, leave blank
    Type: String
  CodeServerInstance:
    Type: String
    Description: ID of the EC2 instance running code-server
  AssetZipS3Path:
    Type: String
    Description: S3 URL for the assets zip file
    Default: ""

Resources:
  CodeServerSSMDoc:
    Type: AWS::SSM::Document
    Properties:
      DocumentType: Command
      Content:
        schemaVersion: '2.2'
        description: Bootstrap code-server instance
        parameters:
          CodeServerPassword:
            type: String
            default: !Ref AWS::StackId
        # all mainSteps scripts are in in /var/lib/amazon/ssm/<instanceid>/document/orchestration/<uuid>/<StepName>/_script.sh
        mainSteps:
          - name: InstallCloudWatchAgent
            action: aws:configurePackage
            inputs:
              name: AmazonCloudWatchAgent
              action: Install
          - name: ConfigureCloudWatchAgent
            action: aws:runDocument
            inputs:
              documentType: SSMDocument
              documentPath: AmazonCloudWatch-ManageAgent
              documentParameters:
                action: configure
                mode: ec2
                optionalConfigurationSource: default
                optionalRestart: 'yes'
          - name: InstallAptPackagesApt
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - dpkg --configure -a
                - apt-get -q update && DEBIAN_FRONTEND=noninteractive apt-get install -y -q apt-utils
                - apt-get -q update && DEBIAN_FRONTEND=noninteractive apt-get install -y -q needrestart unattended-upgrades
                - sed -i 's/#$nrconf{kernelhints} = -1;/$nrconf{kernelhints} = 0;/' /etc/needrestart/needrestart.conf
                - sed -i 's/#$nrconf{verbosity} = 2;/$nrconf{verbosity} = 0;/' /etc/needrestart/needrestart.conf
                - sed -i "s/#\$nrconf{restart} = 'i';/\$nrconf{restart} = 'a';/" /etc/needrestart/needrestart.conf
                - echo "Apt helper packages added. Checking configuration"
                - cat /etc/needrestart/needrestart.conf
          - name: CleanupDLAMINeuronRepo
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 60
              runCommand:
                - '#!/bin/bash'
                - echo "Removing old Neuron repository configuration from DLAMI..."
                - rm -f /etc/apt/sources.list.d/neuron.list
                - echo "Cleanup completed."
          - name: InstallBasePackagesApt
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 600
              runCommand:
                - '#!/bin/bash'
                - echo "Waiting for dpkg lock to be released..."
                - |
                  # Wait for dpkg lock to be released (max 5 minutes)
                  timeout=300
                  elapsed=0
                  while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
                        sudo fuser /var/lib/apt/lists/lock >/dev/null 2>&1 || \
                        sudo fuser /var/cache/apt/archives/lock >/dev/null 2>&1; do
                    if [ $elapsed -ge $timeout ]; then
                      echo "Timeout waiting for dpkg lock"
                      break
                    fi
                    echo "Waiting for dpkg lock... ($elapsed seconds)"
                    sleep 5
                    elapsed=$((elapsed + 5))
                  done
                - dpkg --configure -a
                - apt-get -q update
                - DEBIAN_FRONTEND=noninteractive apt-get install -y -q curl gnupg whois argon2 unzip nginx openssl locales locales-all apt-transport-https ca-certificates software-properties-common python3-pip nodejs npm graphviz jq
                - echo "Base packages installed successfully"
          - name: AddUserApt
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - dpkg --configure -a
                - !Sub |
                  if [[ "${CodeServerUser}" == "ubuntu" ]]
                  then
                    echo 'Using existing user: ${CodeServerUser}'
                  else
                    echo 'Adding user: ${CodeServerUser}'
                    adduser --disabled-password --gecos '' ${CodeServerUser}
                    echo "${CodeServerUser}:{{ CodeServerPassword }}" | chpasswd
                    usermod -aG sudo ${CodeServerUser}
                  fi
                - !Sub |
                  tee /etc/sudoers.d/91-vscode-user <<EOF
                  ${CodeServerUser} ALL=(ALL) NOPASSWD:ALL
                  EOF
                - !Sub mkdir -p /home/${CodeServerUser} && chown -R ${CodeServerUser}:${CodeServerUser} /home/${CodeServerUser}
                - !Sub mkdir -p /home/${CodeServerUser}/.local/bin && chown -R ${CodeServerUser}:${CodeServerUser} /home/${CodeServerUser}
                - echo "User added. Checking configuration"
                - !Sub getent passwd ${CodeServerUser}
          - name: UpdateProfile
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - echo LANG=en_US.utf-8 >> /etc/environment
                - echo LC_ALL=en_US.UTF-8 >> /etc/environment
                - !Sub echo 'PATH=$PATH:/home/${CodeServerUser}/.local/bin' >> /home/${CodeServerUser}/.bashrc
                - !Sub echo 'export PATH' >> /home/${CodeServerUser}/.bashrc
                - !Sub echo 'export AWS_REGION=${AWS::Region}' >> /home/${CodeServerUser}/.bashrc
                - !Sub echo 'export AWS_ACCOUNTID=${AWS::AccountId}' >> /home/${CodeServerUser}/.bashrc
                - !Sub echo 'export NEXT_TELEMETRY_DISABLED=1' >> /home/${CodeServerUser}/.bashrc
                - !Sub echo "export PS1='\[\033[01;32m\]\u:\[\033[01;34m\]\w\[\033[00m\]\$ '" >> /home/${CodeServerUser}/.bashrc
                - !Sub chown -R ${CodeServerUser}:${CodeServerUser} /home/${CodeServerUser}
          - name: InstallAWSCLI
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - mkdir -p /tmp
                - curl -fsSL https://awscli.amazonaws.com/awscli-exe-linux-$(uname -m).zip -o /tmp/aws-cli.zip
                - !Sub chown -R ${CodeServerUser}:${CodeServerUser} /tmp/aws-cli.zip
                - unzip -q -d /tmp /tmp/aws-cli.zip
                - sudo /tmp/aws/install
                - rm -rf /tmp/aws
                - echo "AWS CLI installed. Checking configuration"
                - aws --version
          - name: InstallGitApt
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - dpkg --configure -a
                - add-apt-repository ppa:git-core/ppa
                - apt-get -q update && DEBIAN_FRONTEND=noninteractive apt-get install -y -q git
                - !Sub sudo -u ${CodeServerUser} git config --global user.email "coder@example.com"
                - !Sub sudo -u ${CodeServerUser} git config --global user.name "Workshop Coder"
                - !Sub sudo -u ${CodeServerUser} git config --global init.defaultBranch "main"
                - echo "Git installed. Checking configuration"
                - git --version
          - name: CloneRepo
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 600
              runCommand:
                - '#!/bin/bash'
                - !Sub |
                  if [[ -z "${RepoUrl}" ]]
                  then
                    echo "No Repo"
                  else
                    mkdir -p ${HomeFolder} && chown -R ${CodeServerUser}:${CodeServerUser} ${HomeFolder}
                    sudo -u ${CodeServerUser} git clone ${RepoUrl} ${HomeFolder}
                    echo "Repo ${RepoUrl} cloned. Checking configuration"
                    ls -la ${HomeFolder}
                    sudo -u ${CodeServerUser} git -C ${HomeFolder} remote -v
                  fi

          - name: ConfigureCodeServer
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 600
              runCommand:
                - '#!/bin/bash'
                - !Sub export HOME=/home/${CodeServerUser}
                - curl -fsSL https://code-server.dev/install.sh | bash -s -- 2>&1
                - !Sub systemctl enable --now code-server@${CodeServerUser} 2>&1
                - !Sub |
                  tee /etc/nginx/conf.d/code-server.conf <<EOF
                  server {
                      listen 80;
                      listen [::]:80;
                      # server_name \$\{CloudFrontDistribution.DomainName\};
                      server_name *.cloudfront.net;
                      location / {
                        proxy_pass http://localhost:8080/;
                        proxy_set_header Host \$host;
                        proxy_set_header Upgrade \$http_upgrade;
                        proxy_set_header Connection upgrade;
                        proxy_set_header Accept-Encoding gzip;
                      }
                      location /${DevServerBasePath} {
                        proxy_pass http://localhost:${DevServerPort}/${DevServerBasePath};
                        proxy_set_header Host \$host;
                        proxy_set_header Upgrade \$http_upgrade;
                        proxy_set_header Connection upgrade;
                        proxy_set_header Accept-Encoding gzip;
                      }
                  }
                  EOF
                - !Sub mkdir -p /home/${CodeServerUser}/.config/code-server
                - !Sub |
                  tee /home/${CodeServerUser}/.config/code-server/config.yaml <<EOF
                  cert: false
                  auth: password
                  hashed-password: "$(echo -n {{ CodeServerPassword }} | argon2 $(openssl rand -base64 12) -e)"
                  EOF
                - !Sub mkdir -p /home/${CodeServerUser}/.local/share/code-server/User/
                - !Sub touch /home/${CodeServerUser}/.hushlogin
                - !Sub mkdir -p ${HomeFolder} && chown -R ${CodeServerUser}:${CodeServerUser} ${HomeFolder}
                - !Sub |
                  tee /home/${CodeServerUser}/.local/share/code-server/User/settings.json <<EOF
                  {
                    "extensions.autoUpdate": false,
                    "extensions.autoCheckUpdates": false,
                    "telemetry.telemetryLevel": "off",
                    "security.workspace.trust.startupPrompt": "never",
                    "security.workspace.trust.enabled": false,
                    "security.workspace.trust.banner": "never",
                    "security.workspace.trust.emptyWindow": false,
                    "auto-run-command.rules": [
                      {
                        "command": "workbench.action.terminal.new"
                      }
                    ]
                  }
                  EOF
                - !Sub chown -R ${CodeServerUser}:${CodeServerUser} /home/${CodeServerUser}
                - !Sub systemctl restart code-server@${CodeServerUser}
                - systemctl restart nginx
                - !Sub sudo -u ${CodeServerUser} --login code-server --install-extension AmazonWebServices.aws-toolkit-vscode --force
                - !Sub sudo -u ${CodeServerUser} --login code-server --install-extension AmazonWebServices.amazon-q-vscode --force
                - !Sub sudo -u ${CodeServerUser} --login code-server --install-extension saoudrizwan.claude-dev --force
                - !Sub chown -R ${CodeServerUser}:${CodeServerUser} /home/${CodeServerUser}
                - echo "Nginx installed. Checking configuration"
                - nginx -t 2>&1
                - systemctl status nginx
                - echo "CodeServer installed. Checking configuration"
                - code-server -v
                - !Sub systemctl status code-server@${CodeServerUser}

          - name: SetupCodeCommand
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - |
                  cat > /usr/local/bin/code << EOF
                  #!/bin/bash
                  if [ "\$1" = "." ]; then
                    current_dir=\$(pwd)
                    /usr/bin/code-server \$current_dir
                  elif [ -n "\$1" ]; then
                    target=\$(realpath "\$1" 2>/dev/null || echo "\$1")
                    /usr/bin/code-server \$target
                  fi
                  EOF
                - chmod +x /usr/local/bin/code
          # Install optional packages here - any of these blocks can be deleted if that software is not required for the workshop
          - name: InstallNodeApt
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - apt-get update && apt-get install -y nodejs npm
                - npm install -g n
                - n 22
                - export PATH="/usr/local/bin:$PATH"
                - npm install -g npm@latest
                - echo "Node and npm installed. Checking configuration"
                - node -v
                - npm -v
          - name: InstallAmazonQCLI
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 600
              runCommand:
                - '#!/bin/bash'
                - set -e
                - echo "Amazon Q Developer CLI インストールを開始します..."
                
                # 必要な依存関係をインストール
                - apt-get update -qq
                - DEBIAN_FRONTEND=noninteractive apt-get install -y -q wget ca-certificates
                
                # Amazon Q CLI がすでにインストールされているかチェック
                - |
                  if command -v q &> /dev/null; then
                    echo "Amazon Q Developer CLI は既にインストールされています"
                    q --version || echo "バージョン確認に失敗しましたが、コマンドは存在します"
                    exit 0
                  fi
                
                # 一時ディレクトリの作成
                - TEMP_DIR=$(mktemp -d)
                - cd "$TEMP_DIR"
                
                # Amazon Q CLI .deb パッケージのダウンロード
                - echo "Amazon Q Developer CLI .deb パッケージをダウンロード中..."
                - |
                  if ! wget -q https://desktop-release.q.us-east-1.amazonaws.com/latest/amazon-q.deb; then
                    echo ".deb パッケージのダウンロードに失敗しました"
                    rm -rf "$TEMP_DIR"
                    exit 1
                  fi
                
                # 依存関係の修正（必要に応じて）
                - echo "依存関係を確認中..."
                - apt-get install -f -y
                
                # .deb パッケージのインストール
                - echo "Amazon Q Developer CLI をインストール中..."
                - |
                  if ! dpkg -i amazon-q.deb; then
                    echo "dpkg でのインストールに失敗しました。依存関係を修正してリトライします..."
                    apt-get install -f -y
                    if ! dpkg -i amazon-q.deb; then
                      echo "Amazon Q Developer CLI のインストールに失敗しました"
                      rm -rf "$TEMP_DIR"
                      exit 1
                    fi
                  fi
                
                # クリーンアップ
                - cd /
                - rm -rf "$TEMP_DIR"
                
                # インストール確認
                - echo "インストールを確認中..."
                - |
                  if command -v q &> /dev/null; then
                    echo "Amazon Q Developer CLI のインストールが完了しました"
                    q --version || echo "バージョン確認に失敗しましたが、インストールは成功しました"
                  else
                    echo "Amazon Q Developer CLI のインストールに失敗しました"
                    exit 1
                  fi
                
                # 設定ディレクトリの作成とリソース制限設定
                - !Sub |
                  echo "Amazon Q Developer CLI の設定を行っています..."
                  mkdir -p /home/${CodeServerUser}/.config/amazon-q
                  cat > /home/${CodeServerUser}/.config/amazon-q/config.json << EOF
                  {
                    "maxMemoryMB": 512,
                    "logLevel": "error",
                    "autoUpdate": false
                  }
                  EOF
                  chown -R ${CodeServerUser}:${CodeServerUser} /home/${CodeServerUser}/.config/amazon-q
                
                - echo "Amazon Q Developer CLI のインストールと設定が完了しました"
          - name: Installuv
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 600
              runCommand:
                - '#!/bin/bash'
                - !Sub sudo -u ${CodeServerUser} --login curl -fsSL https://astral.sh/uv/install.sh -o /tmp/uv_install.sh
                - !Sub sudo -u ${CodeServerUser} --login bash /tmp/uv_install.sh
                - !Sub |
                  if uv generate-shell-completion bash &>/dev/null; then
                    echo 'eval "$(uv generate-shell-completion bash)"' >> /home/${CodeServerUser}/.bashrc
                  fi
                - !Sub |
                  if uvx generate-shell-completion bash &>/dev/null; then
                    echo 'eval "$(uvx generate-shell-completion bash)"' >> /home/${CodeServerUser}/.bashrc
                  fi
                - echo "uv installed. Checking configuration"
                - !Sub sudo -u ${CodeServerUser} --login uv --version
          - name: InstallDockerApt
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - dpkg --configure -a
                # - curl -fsSL https://get.docker.com | bash
                - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
                - echo "deb [signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release --codename --short) stable" > /etc/apt/sources.list.d/docker.list
                - apt-get -q update && DEBIAN_FRONTEND=noninteractive apt-get install -y -q docker-ce docker-ce-cli containerd.io
                - !Sub usermod -aG docker ${CodeServerUser}
                - !Sub sudo -u ${CodeServerUser} newgrp docker
                - !Sub systemctl restart code-server@${CodeServerUser}
                - systemctl start docker.service
                - !Sub sudo -u ${CodeServerUser} --login code-server --install-extension ms-azuretools.vscode-docker --force
                - echo "Docker installed. Checking configuration"
                - docker --version
                - systemctl status docker.service

          - name: SetupNeuronEnvironment
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 300
              runCommand:
                - '#!/bin/bash'
                - echo "Configuring Neuron environment (using DLAMI pre-installed packages)..."
                
                # Add Neuron paths and activation alias to user profile
                - !Sub |
                  cat >> /home/${CodeServerUser}/.bashrc << 'EOF'
                  
                  # AWS Neuron environment setup (DLAMI pre-installed)
                  export PATH=/opt/aws/neuron/bin:$PATH
                  # Activate pre-installed Neuron PyTorch environment
                  alias neuron-activate='source /opt/aws_neuronx_venv_pytorch_2_8/bin/activate'
                  EOF
                  
                  chown -R ${CodeServerUser}:${CodeServerUser} /home/${CodeServerUser}/.bashrc
                  echo "Neuron environment configuration completed."
                  echo "DLAMI pre-installed environment: /opt/aws_neuronx_venv_pytorch_2_8"

          - name: ConfigureMCPForAmazonQ
            action: aws:runShellScript
            inputs:
              runCommand:
                - '#!/bin/bash'
                - !Sub |
                  mkdir -p /home/${CodeServerUser}/.aws/amazonq
                  cat > /home/${CodeServerUser}/.aws/amazonq/mcp.json << EOF
                  {
                    "mcpServers": {
                      "awslabs.aws-documentation-mcp-server": {
                        "autoApprove": [
                          "read_documentation",
                          "search_documentation",
                          "recommend"
                        ],
                        "disabled": false,
                        "command": "uvx",
                        "args": [
                          "awslabs.aws-documentation-mcp-server@latest"
                        ],
                        "env": {
                          "FASTMCP_LOG_LEVEL": "ERROR"
                        },
                        "transportType": "stdio"
                      }
                    }
                  }
                  EOF
                - !Sub chown -R ${CodeServerUser}:${CodeServerUser} /home/${CodeServerUser}/.aws

          - name: ConfigureMCPForCline
            action: aws:runShellScript
            inputs:
              runCommand:
                - '#!/bin/bash'
                - !Sub |
                  # Create directory for Cline MCP settings
                  mkdir -p /home/${CodeServerUser}/.local/share/code-server/User/globalStorage/saoudrizwan.claude-dev/settings/

                  # Create the MCP configuration file for Cline
                  cat > /home/${CodeServerUser}/.local/share/code-server/User/globalStorage/saoudrizwan.claude-dev/settings/cline_mcp_settings.json << EOF
                  {
                    "mcpServers": {
                      "awslabs.aws-documentation-mcp-server": {
                        "autoApprove": [
                          "read_documentation",
                          "search_documentation",
                          "recommend"
                        ],
                        "disabled": false,
                        "command": "uvx",
                        "args": [
                          "awslabs.aws-documentation-mcp-server@latest"
                        ],
                        "env": {
                          "FASTMCP_LOG_LEVEL": "ERROR"
                        },
                        "transportType": "stdio"
                      }
                    }
                  }
                  EOF

                  # Set proper ownership
                  chown -R ${CodeServerUser}:${CodeServerUser} /home/${CodeServerUser}/.local/share/code-server

          - name: DownloadAndSetupAssets
            action: aws:runShellScript
            inputs:
              timeoutSeconds: 2400
              runCommand:
                - '#!/bin/bash'
                - !Sub |
                  # Create workshop directory if it doesn't exist
                  mkdir -p ${HomeFolder}
                  chown -R ${CodeServerUser}:${CodeServerUser} ${HomeFolder}

                  # Check if AssetZipS3Path is provided
                  if [[ -z "${AssetZipS3Path}" ]]; then
                    echo "No AssetZipS3Path provided. Skipping asset download."
                    exit 0
                  fi

                  # Download assets directly from S3 URL
                  echo "Downloading assets from: ${AssetZipS3Path}"
                  if ! curl -L "${AssetZipS3Path}" -o /tmp/assets.zip; then
                    echo "Failed to download assets. Skipping."
                    exit 0
                  fi

                  # Verify the downloaded file
                  if [[ ! -f /tmp/assets.zip ]] || [[ ! -s /tmp/assets.zip ]]; then
                    echo "Downloaded file is empty or does not exist. Skipping."
                    exit 0
                  fi

                  # Extract assets to the workshop directory
                  if ! unzip -o /tmp/assets.zip -d ${HomeFolder}; then
                    echo "Failed to extract assets. Skipping."
                    rm -f /tmp/assets.zip
                    exit 0
                  fi

                  rm -f /tmp/assets.zip
                  chown -R ${CodeServerUser}:${CodeServerUser} ${HomeFolder}
                  echo "Assets extracted to ${HomeFolder}"

  # Install Workshop specific packages here
  SSMDocLambdaRole:
    Type: AWS::IAM::Role
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W11
            reason: The Amazon EC2 ssm:*CommandInvocation API actions do not support resource-level permissions, so you cannot control which individual resources users can view in the console. Therefore, the * wildcard is necessary in the Resource element. See https://docs.aws.amazon.com/service-authorization/latest/reference/list_awssystemsmanager.html
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: !Sub lambda.${AWS::URLSuffix}
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Sub arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: SSMDocOnEC2
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - ssm:SendCommand
                Resource:
                  - !Sub arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:document/${CodeServerSSMDoc}
                  - !Sub arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:document/AmazonCloudWatch-ManageAgent
                  - !Sub arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:instance/${CodeServerInstance}
              - Effect: Allow
                Action:
                  - ssm:ListCommandInvocations
                  - ssm:GetCommandInvocation
                Resource: '*'

Outputs:
  CodeServerSSMDocName:
    Description: SSM Document name
    Value: !Ref CodeServerSSMDoc
