{
  "name": "Code Server Setup (Full)",
  "description": "Code Serverの完全なインストールと設定（元のsetup_coder_ubuntu24.shの全機能を含む）",
  "variables": {
    "USER": "coder",
    "PASSWORD": "",
    "HOME_DIR": "/work",
    "INTERNAL_PORT": "8080",
    "NGINX_PORT": "80"
  },
  "tasks": [
    {
      "id": "01-configure-needrestart",
      "name": "Configure needrestart",
      "description": "needrestartの設定を変更して自動再起動を有効化",
      "commands": [
        "echo '==> Configuring needrestart settings'",
        "dpkg --configure -a || true",
        "if [ -f /etc/needrestart/needrestart.conf ]; then",
        "  sed -i 's/#$nrconf{kernelhints} = -1;/$nrconf{kernelhints} = 0;/' /etc/needrestart/needrestart.conf",
        "  sed -i 's/#$nrconf{verbosity} = 2;/$nrconf{verbosity} = 0;/' /etc/needrestart/needrestart.conf",
        "  sed -i \"s/#\\$nrconf{restart} = 'i';/\\$nrconf{restart} = 'a';/\" /etc/needrestart/needrestart.conf",
        "  echo 'needrestart configuration updated'",
        "else",
        "  echo 'needrestart not found, skipping...'",
        "fi"
      ]
    },
    {
      "id": "02-cleanup-neuron-repo",
      "name": "Cleanup old Neuron repository",
      "description": "古いNeuronリポジトリを削除",
      "commands": [
        "echo '==> Cleaning up old Neuron repository'",
        "rm -f /etc/apt/sources.list.d/neuron.list",
        "echo 'Cleanup completed'"
      ]
    },
    {
      "id": "03-wait-for-dpkg-lock",
      "name": "Wait for dpkg lock",
      "description": "dpkgロックの解放を待機",
      "commands": [
        "echo '==> Waiting for dpkg lock to be released'",
        "timeout=300",
        "elapsed=0",
        "while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || fuser /var/lib/apt/lists/lock >/dev/null 2>&1 || fuser /var/cache/apt/archives/lock >/dev/null 2>&1; do",
        "  if [ $elapsed -ge $timeout ]; then",
        "    echo 'Timeout waiting for dpkg lock'",
        "    break",
        "  fi",
        "  echo \"Waiting for dpkg lock... ($elapsed seconds)\"",
        "  sleep 5",
        "  elapsed=$((elapsed + 5))",
        "done",
        "echo 'dpkg lock released'"
      ]
    },
    {
      "id": "04-install-base-packages",
      "name": "Install base packages",
      "description": "基本パッケージをインストール",
      "commands": [
        "echo '==> Installing base packages'",
        "dpkg --configure -a || true",
        "apt-get -q update",
        "DEBIAN_FRONTEND=noninteractive apt-get install -y -q curl gnupg whois argon2 unzip nginx openssl locales locales-all apt-transport-https ca-certificates software-properties-common python3-pip nodejs npm graphviz jq",
        "echo 'Base packages installed successfully'"
      ]
    },
    {
      "id": "05-create-user",
      "name": "Create user account",
      "description": "Code Server用のユーザーアカウントを作成",
      "commands": [
        "echo '==> Creating user: {{USER}}'",
        "dpkg --configure -a || true",
        "if [ '{{USER}}' = 'ubuntu' ]; then",
        "  echo 'Using existing user: {{USER}}'",
        "else",
        "  if id {{USER}} >/dev/null 2>&1; then",
        "    echo 'User {{USER}} already exists'",
        "  else",
        "    adduser --disabled-password --gecos '' {{USER}}",
        "    echo 'User {{USER}} created successfully'",
        "  fi",
        "  # Set password if provided",
        "  if [ -n '{{PASSWORD}}' ]; then",
        "    echo '{{USER}}:{{PASSWORD}}' | chpasswd",
        "    echo 'Password set for user {{USER}}'",
        "  fi",
        "  # Add to sudo group",
        "  usermod -aG sudo {{USER}}",
        "  echo 'User {{USER}} added to sudo group'",
        "fi",
        "getent passwd {{USER}}"
      ]
    },
    {
      "id": "06-configure-sudo",
      "name": "Configure sudo access",
      "description": "パスワードなしsudo権限を設定",
      "commands": [
        "echo '==> Configuring sudo access for {{USER}}'",
        "cat > /etc/sudoers.d/91-vscode-user << 'EOF'",
        "{{USER}} ALL=(ALL) NOPASSWD:ALL",
        "EOF",
        "chmod 0440 /etc/sudoers.d/91-vscode-user",
        "echo 'Sudo configuration completed'"
      ]
    },
    {
      "id": "07-create-home-dir",
      "name": "Create home directory",
      "description": "ホームディレクトリを作成",
      "commands": [
        "echo '==> Creating home directory: {{HOME_DIR}}'",
        "mkdir -p {{HOME_DIR}}",
        "mkdir -p /home/{{USER}}/.local/bin",
        "chown -R {{USER}}:{{USER}} /home/{{USER}}",
        "chown -R {{USER}}:{{USER}} {{HOME_DIR}}",
        "echo 'Home directory ready'"
      ]
    },
    {
      "id": "08-configure-profile",
      "name": "Configure user profile",
      "description": "ユーザープロファイルと環境変数を設定",
      "commands": [
        "echo '==> Configuring user profile'",
        "# Set system environment",
        "echo 'LANG=en_US.utf-8' >> /etc/environment",
        "echo 'LC_ALL=en_US.UTF-8' >> /etc/environment",
        "",
        "# Configure .bashrc",
        "cat >> /home/{{USER}}/.bashrc << 'BASHRC_EOF'",
        "",
        "# Path configuration",
        "PATH=$PATH:/home/{{USER}}/.local/bin",
        "export PATH",
        "",
        "# Disable telemetry",
        "export NEXT_TELEMETRY_DISABLED=1",
        "",
        "# Custom prompt",
        "export PS1='\\[\\033[01;32m\\]\\u:\\[\\033[01;34m\\]\\w\\[\\033[00m\\]\\$ '",
        "BASHRC_EOF",
        "",
        "# Create .hushlogin to suppress login messages",
        "touch /home/{{USER}}/.hushlogin",
        "",
        "chown -R {{USER}}:{{USER}} /home/{{USER}}",
        "echo 'User profile configured'"
      ]
    },
    {
      "id": "09-install-code-server",
      "name": "Install Code Server",
      "description": "Code Serverをインストール",
      "commands": [
        "echo '==> Installing Code Server'",
        "if [ -f /usr/bin/code-server ] || command -v code-server >/dev/null 2>&1; then",
        "  echo 'Code Server is already installed'",
        "  /usr/bin/code-server --version || code-server --version",
        "else",
        "  echo 'Installing Code Server...'",
        "  export HOME=/root",
        "  curl -fsSL https://code-server.dev/install.sh | sh 2>&1",
        "  echo 'Code Server installed successfully'",
        "  /usr/bin/code-server --version",
        "fi"
      ]
    },
    {
      "id": "10-configure-code-server",
      "name": "Configure Code Server",
      "description": "Code Serverの設定ファイルを作成",
      "commands": [
        "echo '==> Configuring Code Server'",
        "mkdir -p /home/{{USER}}/.config/code-server",
        "",
        "# Generate hashed password",
        "SALT=$(openssl rand -base64 12)",
        "HASHED_PASSWORD=$(echo -n '{{PASSWORD}}' | argon2 $SALT -e)",
        "",
        "# Create config file",
        "cat > /home/{{USER}}/.config/code-server/config.yaml << EOF",
        "cert: false",
        "auth: password",
        "hashed-password: \"$HASHED_PASSWORD\"",
        "EOF",
        "",
        "chown -R {{USER}}:{{USER}} /home/{{USER}}/.config",
        "echo 'Code Server configuration created'"
      ]
    },
    {
      "id": "11-configure-vscode-settings",
      "name": "Configure VS Code settings",
      "description": "VS Codeのユーザー設定を作成",
      "commands": [
        "echo '==> Configuring VS Code settings'",
        "mkdir -p /home/{{USER}}/.local/share/code-server/User/",
        "",
        "cat > /home/{{USER}}/.local/share/code-server/User/settings.json << 'EOF'",
        "{",
        "  \"extensions.autoUpdate\": false,",
        "  \"extensions.autoCheckUpdates\": false,",
        "  \"telemetry.telemetryLevel\": \"off\",",
        "  \"security.workspace.trust.startupPrompt\": \"never\",",
        "  \"security.workspace.trust.enabled\": false,",
        "  \"security.workspace.trust.banner\": \"never\",",
        "  \"security.workspace.trust.emptyWindow\": false,",
        "  \"auto-run-command.rules\": [",
        "    {",
        "      \"command\": \"workbench.action.terminal.new\"",
        "    }",
        "  ]",
        "}",
        "EOF",
        "",
        "chown -R {{USER}}:{{USER}} /home/{{USER}}/.local",
        "echo 'VS Code settings configured'"
      ]
    },
    {
      "id": "12-configure-nginx",
      "name": "Configure nginx",
      "description": "nginxリバースプロキシを設定（タイムアウト対策とWebSocket対応）",
      "commands": [
        "echo '==> Configuring nginx'",
        "",
        "# Remove default site to avoid conflicts",
        "rm -f /etc/nginx/sites-enabled/default",
        "",
        "# Create nginx configuration with proper timeout and WebSocket support",
        "cat > /etc/nginx/conf.d/code-server.conf << 'EOF'",
        "server {",
        "    listen {{NGINX_PORT}} default_server;",
        "    listen [::]:{{NGINX_PORT}} default_server;",
        "    server_name _;",
        "",
        "    # タイムアウト設定（3600秒 = 1時間）",
        "    # 504 Gateway Timeout対策",
        "    proxy_connect_timeout 3600s;",
        "    proxy_send_timeout 3600s;",
        "    proxy_read_timeout 3600s;",
        "    send_timeout 3600s;",
        "",
        "    # WebSocket対応",
        "    proxy_http_version 1.1;",
        "    proxy_set_header Upgrade $http_upgrade;",
        "    proxy_set_header Connection \"upgrade\";",
        "",
        "    # その他のヘッダー設定",
        "    proxy_set_header Host $host;",
        "    proxy_set_header X-Real-IP $remote_addr;",
        "    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;",
        "    proxy_set_header X-Forwarded-Proto $scheme;",
        "    proxy_set_header Accept-Encoding gzip;",
        "",
        "    # バッファリング設定（リアルタイム性を優先）",
        "    proxy_buffering off;",
        "    proxy_request_buffering off;",
        "",
        "    location / {",
        "        proxy_pass http://localhost:{{INTERNAL_PORT}}/;",
        "    }",
        "}",
        "EOF",
        "",
        "# Test nginx configuration",
        "nginx -t",
        "",
        "# Restart nginx",
        "systemctl restart nginx",
        "systemctl enable nginx",
        "",
        "echo 'nginx configured successfully with timeout and WebSocket support'"
      ]
    },
    {
      "id": "13-create-systemd-service",
      "name": "Create systemd service",
      "description": "Code ServerのsystemdサービスUnitを作成",
      "commands": [
        "echo '==> Creating systemd service'",
        "cat > /etc/systemd/system/code-server@{{USER}}.service << 'EOF'",
        "[Unit]",
        "Description=code-server",
        "After=network.target",
        "",
        "[Service]",
        "Type=exec",
        "ExecStart=/usr/bin/code-server",
        "Restart=always",
        "User={{USER}}",
        "",
        "[Install]",
        "WantedBy=multi-user.target",
        "EOF",
        "",
        "echo 'Systemd service file created'"
      ]
    },
    {
      "id": "14-enable-and-start-service",
      "name": "Enable and start service",
      "description": "Code Serverサービスを有効化して起動",
      "commands": [
        "echo '==> Enabling and starting Code Server service'",
        "systemctl daemon-reload",
        "",
        "# Enable service",
        "systemctl enable --now code-server@{{USER}}",
        "echo 'Code Server service enabled'",
        "",
        "# Restart service to apply configuration",
        "systemctl restart code-server@{{USER}}",
        "systemctl restart nginx",
        "echo 'Services restarted'",
        "",
        "# Wait for service to start",
        "sleep 5",
        "",
        "# Check status",
        "if systemctl is-active --quiet code-server@{{USER}}; then",
        "  echo 'Code Server is running successfully'",
        "  systemctl status code-server@{{USER}} --no-pager | head -20",
        "else",
        "  echo 'ERROR: Code Server failed to start'",
        "  systemctl status code-server@{{USER}} --no-pager",
        "  exit 1",
        "fi",
        "",
        "if systemctl is-active --quiet nginx; then",
        "  echo 'nginx is running successfully'",
        "else",
        "  echo 'WARNING: nginx failed to start'",
        "  systemctl status nginx --no-pager",
        "fi"
      ]
    },
    {
      "id": "15-install-vscode-extensions",
      "name": "Install VS Code extensions",
      "description": "VS Code拡張機能をインストール",
      "commands": [
        "echo '==> Installing VS Code extensions'",
        "",
        "# Install AWS Toolkit",
        "sudo -u {{USER}} --login code-server --install-extension AmazonWebServices.aws-toolkit-vscode --force || echo 'AWS Toolkit installation skipped'",
        "",
        "# Install Amazon Q",
        "sudo -u {{USER}} --login code-server --install-extension AmazonWebServices.amazon-q-vscode --force || echo 'Amazon Q installation skipped'",
        "",
        "# Install Cline (Claude Dev)",
        "sudo -u {{USER}} --login code-server --install-extension saoudrizwan.claude-dev --force || echo 'Cline installation skipped'",
        "",
        "chown -R {{USER}}:{{USER}} /home/{{USER}}",
        "echo 'VS Code extensions installation completed'"
      ]
    },
    {
      "id": "16-create-code-command",
      "name": "Create code command",
      "description": "code コマンドのラッパースクリプトを作成",
      "commands": [
        "echo '==> Creating code command'",
        "cat > /usr/local/bin/code << 'WRAPPER_EOF'",
        "#!/bin/bash",
        "if [ \"$1\" = \".\" ]; then",
        "  current_dir=$(pwd)",
        "  /usr/bin/code-server $current_dir",
        "elif [ -n \"$1\" ]; then",
        "  target=$(realpath \"$1\" 2>/dev/null || echo \"$1\")",
        "  /usr/bin/code-server $target",
        "fi",
        "WRAPPER_EOF",
        "",
        "chmod +x /usr/local/bin/code",
        "echo 'code command created'"
      ]
    },
    {
      "id": "17-verify-installation",
      "name": "Verify installation",
      "description": "インストールと設定を確認",
      "commands": [
        "echo ''",
        "echo '========================================='",
        "echo 'Setup Verification'",
        "echo '========================================='",
        "",
        "# User confirmation",
        "echo 'User: {{USER}}'",
        "id {{USER}}",
        "",
        "# Directory confirmation",
        "echo ''",
        "echo 'Home directory: {{HOME_DIR}}'",
        "ls -la {{HOME_DIR}} | head -5",
        "",
        "# Code Server version",
        "echo ''",
        "echo 'Code Server version:'",
        "/usr/bin/code-server --version",
        "",
        "# Service status",
        "echo ''",
        "echo 'Code Server service status:'",
        "systemctl is-active code-server@{{USER}} && echo 'ACTIVE' || echo 'INACTIVE'",
        "",
        "echo ''",
        "echo 'nginx service status:'",
        "systemctl is-active nginx && echo 'ACTIVE' || echo 'INACTIVE'",
        "",
        "# Port confirmation",
        "echo ''",
        "echo 'Listening ports:'",
        "ss -tlnp | grep -E '({{INTERNAL_PORT}}|{{NGINX_PORT}})' || echo 'Ports not found'",
        "",
        "# nginx configuration test",
        "echo ''",
        "echo 'nginx configuration:'",
        "nginx -t 2>&1",
        "",
        "echo ''",
        "echo '========================================='",
        "echo 'Setup completed successfully!'",
        "echo '========================================='",
        "echo 'Code Server is running on port {{INTERNAL_PORT}}'",
        "echo 'nginx is proxying on port {{NGINX_PORT}}'",
        "echo ''",
        "echo 'Access Code Server at: http://[YOUR_INSTANCE_IP]:{{NGINX_PORT}}'"
      ]
    }
  ]
}
